---
layout: post
title: Hash一致性
categories:
- Hash
tags:
- 一致性
- Hash
- 失效
---

服务器做负载均衡常用**轮询法**和**哈希法**，这里讨论哈希法的应用。

**0 Hash**

假设有N台Cache服务器，我们将每个客户请求分派到0~N-1号服务器上，分派简单的使用 *Hash(Object)%N* 来指定Cache服务器。

当有一台服务器宕机，暂定第0号服务器（最坏情况）。那么这时只有N-1台服务器在工作，上述分派方法变成了 *Hash(Object)%(N-1)* 。原来应该存贮在0号服务器上的Cache被存到了原1号服务器上，原来应该贮存到1号服务器上的Cache被放到了原2号服务器……。结果就是，所有的Object Cache都需要重新映射一次，造成所谓的“颠簸”——大量Cache失效或者数据转移。

如果部署一台新的Cache服务器，并编号为i（0<= i <= N）。那么当i！= N时，原来映射到原i号服务器上的Object这次要重新在新的服务器上存贮，原来映射到i+1号服务器上的数据这次要重映射到原i号服务器。结果是，从原i号服务器开始，所有贮存的数据Cache都失效了。

解决方案就是一致性哈希——将Object和Cache服务器同时经过Hash函数映射到同一个Hash空间，然后按照一定方向查找Object存贮所需要的Cache服务器。这样，就可以把服务器失效，从上述最坏情况下的所有Cache失效，变成只有一小部分（原来需要存贮在损坏的Cache服务器上的Object）Cache失效。

**1 Consistent Hashing**

**1.1 Hash空间**

通常意义上的Hash都是将value进行模M运算，所得到的key是一个0~M-1的环形空间内的数字。

![](/images/2014-04-2-1_1-1.JPG)

**1.2 对象映射到Hash空间**

现在我们把Object映射到Hash空间，***然后不做上述模N（%N）的二次处理*** 。

![](/images/2014-04-2-1_2-1.JPG)

**1.3 Cache服务器映射到Hash空间**

将Cache服务器的IP当做value进行Hash处理，并且Hash函数和1.2节中相同。这样服务器和Object都被映射在同一个Hash地址空间内。

![](/images/2014-04-2-1_3-1.JPG)

**1.4 对象映射到服务器**

现在经过Hash处理，Cache服务器和Object都在同一个地址空间内，接着我们要把Object映射到Cache上。

我们顺着一个方向（比如顺时针），那么在这个环形地址空间中，从Object的key出发寻找一个最近的Cache服务器，并储存。

![](/images/2014-04-2-1_4-1.JPG)

**1.5 服务器宕机**

我们假设B服务器宕机了，那么从keyA（Hash地址空间中Cache A服务器的地址）到keyB（Hash地址空间中Cache B服务器的地址）之间的所有Cache全部失效，需要重新映射。**但是**，除此之外，其余的Object Cache全部是有效的，不需要迁移和重映射。**这里就是和第0节相比有所优化的地方**。

![](/images/2014-04-2-1_5-1.JPG)

**1.6 添加服务器**

同1.5节，如果我们添加一台服务器在Cache C与Cache B之间，那么失效的Cache范围仅仅是keyB到keyD之间，而不是第0节中的Cache B，Cache A服务器上的所有数据。

![](/images/2014-04-2-1_6-1.JPG)

**2 虚拟节点**

平衡性是指结果能够尽可能的分布到所有服务器当中去，所有的服务器得到均衡利用。

然而Hash算法并不保证均衡，反而是Hash不可避免的会出现“聚集”现象。在1.5节中，Cache A储存了Object1，Cache C储存了Object2-3-4。

为了解决均衡问题，又引入了“虚拟节点”。我们把Hash空间中的Cache服务器全部换成虚拟的服务器，然后将存贮在虚拟服务器上的数据放入实际的Cache服务器中。这些过程对于Object来说，都是透明的。Object仅能找到“虚拟节点”并储存。

![](/images/2014-04-2-2-1.JPG)

上图中，Object的映射关系为：objec1->cache A2 ； objec2->cache A1 ； objec3->cache C1 ； objec4->cache C2 。  
上图中，Cache服务器和虚拟节点关系为：Cache A1/A2->Cache A；Cache C1/C2->Cache C。

这样Object 1/2都映射在Cache A上，Object 3/4都映射在了Cache C服务器上。

引入“虚拟节点”后，映射关系如图。

![](/images/2014-04-2-2-2.JPG)

引入虚拟节点后，Cache服务器的Hash函数不变，其value由

{% highlight Bash shell scripts %}
Hash("202.38.70.32");  // cache A1

Hash("202.168.70.33");  // cache A2
{% endhighlight %}

变为

{% highlight Bash shell scripts %}
Hash("202.38.70.32#1");  // cache A1

Hash("202.168.70.33#2");  // cache A2
{% endhighlight %}