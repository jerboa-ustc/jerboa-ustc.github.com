---
layout: post
title: C++ 对象内存布局 虚拟继承 虚函数
categories:
- C++
tags:
- Programming
- C++
- Gcc
- VS
---

文章前2/3部分在说**虚拟继承**或者有**虚函数**的情况下对象的内存布局，后1/3提到了VS下**既有虚拟继承又有虚函数**下的内存布局。

**谈VC++对象模型**

*（美）简.格雷**，程化 译*

**0. 译者前言**

一个C++程序员，想要进一步提升技术水平的话，应该多了解一些语言的语意细节。对于使用VC++的程序员来说，还应该了解一些VC++对于C++的诠释。 Inside the C++ Object Model虽然是一本好书，然而，书的篇幅多一些，又和具体的VC++关系小一些。因此，从篇幅和内容来看，译者认为本文是深入理解C++对象模型比较好的一个出发点。
这篇文章以前看到时就觉得很好，旧文重读，感觉理解得更多一些了，于是产生了翻译出来，与大家共享的想法。虽然文章不长，但时间有限，又若干次在翻译时打盹睡着，拖拖拉拉用了小一个月。
一方面因本人水平所限，另一方面因翻译时经常打盹，错误之处恐怕不少，欢迎大家批评指正。

本文原文出处为[MSDN](http://msdn.microsoft.com/zh-cn/archive/default.asp?url=/archive/en-us/dnarvc/html/jangrayhood.asp)(jerboa:链接已失效)。如果你安装了MSDN，可以搜索到C++ Under the Hood。否则也可在网站上找到。

**1. 前言**

了解你所使用的编程语言究竟是如何实现的，对于C++程序员可能特别有意义。首先，它可以去除我们对于所使用语言的神秘感，使我们不至于对于编译器干的活感到完全不可思议；尤其重要的是，它使我们在Debug和使用语言高级特性的时候，有更多的把握。当需要提高代码效率的时候，这些知识也能够很好地帮助我们。

本文着重回答这样一些问题：

1. 类如何布局？
2. 成员变量如何访问？
3. 成员函数如何访问？
4. 所谓的“调整块”（adjuster thunk）是怎么回事？
5. 使用如下机制时，开销如何：
	- 单继承、多重继承、虚继承
	- 虚函数调用
	- 强制转换到基类，或者强制转换到虚基类
	- 异常处理

首先，我们顺次考察C兼容的结构（struct）的布局，单继承，多重继承，以及虚继承；  
接着，我们讲成员变量和成员函数的访问，当然，这里面包含虚函数的情况；  
再接下来，我们考察构造函数，析构函数，以及特殊的赋值操作符成员函数是如何工作的，数组是如何动态构造和销毁的；  
最后，简单地介绍对异常处理的支持。

对每个语言特性，我们将简要介绍该特性背后的动机，该特性自身的语意（当然，本文决不是“C++入门”，大家对此要有充分认识），以及该特性在微软的 VC++中是如何实现的。这里要注意区分抽象的C++语言语意与其特定实现。微软之外的其他C++厂商可能提供一个完全不同的实现，我们偶尔也会将 VC++的实现与其他实现进行比较。

**2. 类布局**

本节讨论不同的继承方式造成的不同内存布局。

**2.1 C结构(struct)**

由于C++基于C，所以C++也“基本上”兼容C。特别地，C++规范在“结构”上使用了和C相同的，简单的内存布局原则：成员变量按其被声明的顺序排列，按具体实现所规定的对齐原则在内存地址上对齐。 所有的C/C++厂商都保证他们的C/C++编译器对于有效的C结构采用完全相同的布局。这里，A是一个简单的C结构，其成员布局和对齐方式都一目了然。

![](/images/2014-03-24-2_1-1.PNG)

{% highlight c %}
struct A {
   char c;
   int i;
};
{% endhighlight %}

译者注：从上图可见，A在内存中占有8个字节，按照声明成员的顺序，前4个字节包含一个字符（实际占用1个字节，3个字节空着，补对齐），后4个字节包含一个整数。A的指针就指向字符开始字节处。